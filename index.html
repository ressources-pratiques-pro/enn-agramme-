<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ennéagramme</title>
  <link rel="stylesheet" href="assets/css/app.css?v=99" />
  <style>
    .uiCard{ text-align:left; }
    .uiHeader{ display:flex; flex-direction:column; gap:6px; margin-bottom:14px; }
    .uiTop{ display:flex; align-items:baseline; gap:12px; }
    .uiTypeNum{ font-size:44px; line-height:1; font-weight:900; letter-spacing:-.5px; }
    .uiTypeName{ font-size:16px; font-weight:800; opacity:.95; }
    .uiInfo{ display:grid; grid-template-columns:1fr; gap:10px; margin:12px 0 14px; }
    .uiKV{ display:flex; flex-direction:column; gap:4px; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); }
    .uiK{ font-size:12px; letter-spacing:.06em; text-transform:uppercase; opacity:.7; }
    .uiV{ font-size:14px; font-weight:650; opacity:.95; }
    .uiMoves{ display:flex; flex-direction:column; gap:10px; margin-bottom:14px; }
    .uiMove{ padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.03); }
    .uiMove .uiLine{ display:flex; gap:8px; align-items:baseline; flex-wrap:wrap; }
    .uiMove .dot{ width:9px; height:9px; border-radius:50%; display:inline-block; }
    .uiActions{ display:flex; flex-direction:column; gap:10px; align-items:stretch; }
    .uiActions .btn, .uiActions button.btn{ width:100%; justify-content:flex-start; text-align:left; }
    .uiActions .btn[aria-disabled="true"]{ pointer-events:none; opacity:.5; }
    #techSink{ display:none; }
    #infoCard.isClosed{ opacity:.6; }

    footer.siteFooter{opacity:0.9;margin-top:18px;padding:14px 0;text-align:center;font-size:13px;}
    footer.siteFooter .sep{opacity:0.4;margin:0 8px;}
    footer.siteFooter a{color:inherit;text-decoration:none;opacity:0.9;}
    footer.siteFooter a:hover{opacity:1;text-decoration:underline;}
  </style>
</head>
<body>
  <main class="wrap">
    <header>
      <h1>Ennéagramme</h1>
      <p class="subtitle">Clique sur un type pour voir un résumé, puis ouvrir la fiche complète.</p>
      <button id="btnReset" class="reset">Réinitialiser</button>
    </header>

    <section class="grid">
      <div class="diagram">
        <svg viewBox="0 0 420 420" id="enneaSvg" aria-label="Diagramme Ennéagramme" role="img">
          <circle cx="210" cy="210" r="180" class="outer" />
          <g class="inner">
            <circle cx="210" cy="210" r="120" />
            <line x1="210" y1="30" x2="210" y2="390" />
            <line x1="60" y1="300" x2="360" y2="300" />
            <line x1="60" y1="120" x2="360" y2="120" />
          </g>
          <g class="lines" id="moveLines"></g>
          <g class="nodes" id="nodes"></g>
          <text x="210" y="170" text-anchor="middle" class="label inst">Instinctif</text>
          <text x="135" y="270" text-anchor="middle" class="label ment">Mental</text>
          <text x="285" y="270" text-anchor="middle" class="label emot">Émotionnel</text>
        </svg>
      </div>

      <aside class="side" aria-live="polite">
        <div class="card uiCard isClosed" id="infoCard">
          <div class="uiHeader">
            <div class="uiTop">
              <div class="uiTypeNum" id="uiTypeNum">—</div>
              <div class="uiTypeName" id="uiTypeName">Clique sur un type</div>
            </div>
          </div>

          <div class="uiInfo">
            <div class="uiKV"><div class="uiK">Centre d'intelligence</div><div class="uiV" id="uiCenter">—</div></div>
            <div class="uiKV"><div class="uiK">Peur de base</div><div class="uiV" id="uiFear">—</div></div>
            <div class="uiKV"><div class="uiK">Désir de base</div><div class="uiV" id="uiDesire">—</div></div>
            <div class="uiKV"><div class="uiK">Compulsion (évitement)</div><div class="uiV" id="uiCompulsion">—</div></div>
          </div>

          <div class="uiMoves">
            <div class="uiMove">
              <div class="uiLine"><span class="dot" style="background:rgba(109,219,160,.95)"></span><strong>Intégration</strong>&nbsp;(santé)&nbsp;→&nbsp;<span id="uiToIntegr">—</span>&nbsp;:&nbsp;<span id="uiMoveHealthText">—</span></div>
            </div>
            <div class="uiMove">
              <div class="uiLine"><span class="dot" style="background:rgba(255,126,156,.95)"></span><strong>Désintégration</strong>&nbsp;(stress)&nbsp;→&nbsp;<span id="uiToDisint">—</span>&nbsp;:&nbsp;<span id="uiMoveStressText">—</span></div>
            </div>
          </div>

          <div class="uiActions">
            <a id="uiOpenFull" class="btn" href="#" aria-disabled="true">Voir la fiche complète</a>
            <a class="btn" href="test-enneagramme-sans-indice.html">Test Ennéagramme</a>
            <button id="uiCloseCard" class="btn" type="button">Explorer l'Ennéagramme</button>
          </div>
        </div>

        <div id="techSink">
          <div class="badgeRow">
            <div class="badge"><strong>Type</strong> <span id="badgeNum">—</span></div>
          </div>

          <div class="card">
            <div class="miniGrid">
              <div class="mini"><h3>Centre d'intelligence</h3><p id="center">-</p></div>
              <div class="mini"><h3>Peur de base</h3><p id="fear">-</p></div>
              <div class="mini"><h3>Désir de base</h3><p id="desire">-</p></div>
              <div class="mini"><h3>Compulsion (évitement)</h3><p id="compulsion">-</p></div>
            </div>

            <div class="moves">
              <div class="move health">
                <span class="dot"></span>
                <div>
                  <strong>Intégration</strong> (santé) &gt; <span id="toIntegr">-</span> :
                  <span id="moveHealthText">-</span>
                </div>
              </div>
              <div class="move stress">
                <span class="dot"></span>
                <div>
                  <strong>Désintégration</strong> (stress) &gt; <span id="toDisint">-</span> :
                  <span id="moveStressText">-</span>
                </div>
              </div>
            </div>

            <div class="ctaRow">
              <a id="openFull" class="btn" href="type.html?type=1" aria-disabled="true">Voir la fiche complète</a>
              <a id="openProfil" class="btn" href="profil.html?type=1" aria-disabled="true">Niveaux &amp; Profil</a>
              <a class="btn" href="explore.html">Explorer l'Ennéagramme</a>
            </div>
          </div>
        </div>
      </aside>
    </section>

    <footer class="siteFooter">
      <span>Brams — Tous droits réservés</span>
      <span class="sep">|</span>
      <a href="mailto:brahms@example.com" aria-label="Écrire à Brahms">✉ Écrire à Brahms</a>
    </footer>
  </main>

  <script src="assets/js/app.js"></script>

  <script>
    (function(){
      const tech = {
        badgeNum: document.getElementById('badgeNum'),
        center: document.getElementById('center'),
        fear: document.getElementById('fear'),
        desire: document.getElementById('desire'),
        compulsion: document.getElementById('compulsion'),
        toIntegr: document.getElementById('toIntegr'),
        toDisint: document.getElementById('toDisint'),
        moveHealthText: document.getElementById('moveHealthText'),
        moveStressText: document.getElementById('moveStressText'),
        card: document.getElementById('infoCard'),
        reset: document.getElementById('btnReset'),
      };

      const ui = {
        typeNum: document.getElementById('uiTypeNum'),
        typeName: document.getElementById('uiTypeName'),
        center: document.getElementById('uiCenter'),
        fear: document.getElementById('uiFear'),
        desire: document.getElementById('uiDesire'),
        compulsion: document.getElementById('uiCompulsion'),
        toIntegr: document.getElementById('uiToIntegr'),
        toDisint: document.getElementById('uiToDisint'),
        moveHealthText: document.getElementById('uiMoveHealthText'),
        moveStressText: document.getElementById('uiMoveStressText'),
        openFull: document.getElementById('uiOpenFull'),
        close: document.getElementById('uiCloseCard'),
      };

      let typesData = null;

      async function tryFetchJson(url){
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error(String(res.status));
        return res.json();
      }

      async function loadTypes(){
        try{
          try{
            typesData = await tryFetchJson('data/types.json');
          }catch(_){
            typesData = await tryFetchJson('assets/data/types.json');
          }
          syncFromTech();
        }catch(_){}
      }
      loadTypes();

      function getTypeName(n){
        if(!typesData) return '';

        if(Array.isArray(typesData)){
          const item = typesData.find(x => String(x.id ?? x.num ?? x.type) === String(n));
          if(item && typeof item === 'object') return item.name || item.title || item.label || '';
          return '';
        }

        const keyCandidates = [String(n), n, `type${n}`, `Type${n}`];
        for(const k of keyCandidates){
          const v = typesData[k];
          if(v && typeof v === 'object') return v.name || v.title || v.label || '';
        }
        return '';
      }

      function normalizeDash(s){
        const t = (s ?? '').toString().trim();
        return t && t !== '-' ? t : '—';
      }

      function setFullLink(n){
        const ok = Number.isFinite(n) && n >= 1 && n <= 9;
        if(ok){
          ui.openFull.href = `profils/type${n}.html`;
          ui.openFull.removeAttribute('aria-disabled');
        }else{
          ui.openFull.href = '#';
          ui.openFull.setAttribute('aria-disabled', 'true');
        }
      }

      function setClosedState(closed){
        tech.card.classList.toggle('isClosed', !!closed);
      }

      function syncFromTech(){
        const numStr = (tech.badgeNum?.textContent || '').trim();
        const num = parseInt(numStr, 10);
        const hasNum = Number.isFinite(num) && num >= 1 && num <= 9;

        if(!hasNum){
          ui.typeNum.textContent = '—';
          ui.typeName.textContent = 'Clique sur un type';
          ui.center.textContent = '—';
          ui.fear.textContent = '—';
          ui.desire.textContent = '—';
          ui.compulsion.textContent = '—';
          ui.toIntegr.textContent = '—';
          ui.toDisint.textContent = '—';
          ui.moveHealthText.textContent = '—';
          ui.moveStressText.textContent = '—';
          setFullLink(NaN);
          setClosedState(true);
          return;
        }

        ui.typeNum.textContent = String(num);
        const nm = getTypeName(num);
        ui.typeName.textContent = nm ? nm : `Type ${num}`;

        ui.center.textContent = normalizeDash(tech.center?.textContent);
        ui.fear.textContent = normalizeDash(tech.fear?.textContent);
        ui.desire.textContent = normalizeDash(tech.desire?.textContent);
        ui.compulsion.textContent = normalizeDash(tech.compulsion?.textContent);
        ui.toIntegr.textContent = normalizeDash(tech.toIntegr?.textContent);
        ui.toDisint.textContent = normalizeDash(tech.toDisint?.textContent);
        ui.moveHealthText.textContent = normalizeDash(tech.moveHealthText?.textContent);
        ui.moveStressText.textContent = normalizeDash(tech.moveStressText?.textContent);

        setFullLink(num);
        setClosedState(false);
      }

      const observer = new MutationObserver(syncFromTech);
      if(tech.badgeNum){
        observer.observe(tech.badgeNum, { childList:true, characterData:true, subtree:true });
      }
      [tech.center, tech.fear, tech.desire, tech.compulsion, tech.toIntegr, tech.toDisint, tech.moveHealthText, tech.moveStressText]
        .filter(Boolean)
        .forEach(el => observer.observe(el, { childList:true, characterData:true, subtree:true }));

      ui.close?.addEventListener('click', () => {
        if(tech.reset) tech.reset.click();
        setFullLink(NaN);
        setClosedState(true);
        ui.typeNum.textContent = '—';
        ui.typeName.textContent = 'Clique sur un type';
        ui.center.textContent = '—';
        ui.fear.textContent = '—';
        ui.desire.textContent = '—';
        ui.compulsion.textContent = '—';
        ui.toIntegr.textContent = '—';
        ui.toDisint.textContent = '—';
        ui.moveHealthText.textContent = '—';
        ui.moveStressText.textContent = '—';
      });

      syncFromTech();
    })();
  </script>
</body>
</html>
