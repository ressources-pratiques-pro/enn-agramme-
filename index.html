<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat privé</title>

  <!-- (optionnel) tu peux garder ton app.css si tu veux le même thème -->
  <link rel="stylesheet" href="assets/css/app.css?v=201" />

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    .chat-wrap {
      width: 100%;
      max-width: 480px;
      height: 80vh;
      max-height: 680px;
      background: #020617;
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,.5);
      box-shadow: 0 20px 40px rgba(15,23,42,.8);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(148,163,184,.4);
      display: flex;
      align-items: center;
      gap: 12px;
      background: radial-gradient(circle at top left,#1d4ed8,#020617);
    }

    .chat-header .avatar {
      width: 48px;
      height: 48px;
      border-radius: 999px;
      overflow: hidden;
      flex-shrink: 0;
      border: 2px solid rgba(248,250,252,.8);
      background: #0f172a;
    }

    .chat-header .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .chat-header .info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-header .info h1 {
      font-size: 16px;
      margin: 0;
    }

    .chat-header .info span {
      font-size: 12px;
      color: #cbd5f5;
    }

    .chat-messages {
      flex: 1;
      padding: 16px 16px 8px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: radial-gradient(circle at bottom,#020617,#020617);
    }

    .msg {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .msg.me {
      align-self: flex-end;
      background: #4f46e5;
      color: #e5e7eb;
      border-bottom-right-radius: 4px;
    }

    .msg.other {
      align-self: flex-start;
      background: #0f172a;
      border: 1px solid rgba(148,163,184,.5);
      border-bottom-left-radius: 4px;
    }

    .msg-meta {
      font-size: 10px;
      opacity: .7;
      margin-top: 2px;
    }

    .chat-form {
      padding: 10px 12px;
      border-top: 1px solid rgba(148,163,184,.4);
      background: #020617;
      display: flex;
      gap: 8px;
    }

    .chat-form input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.6);
      padding: 8px 12px;
      font-size: 14px;
      background: #020617;
      color: #e5e7eb;
      outline: none;
    }

    .chat-form input::placeholder {
      color: #64748b;
    }

    .chat-form button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      background: #4f46e5;
      color: #e5e7eb;
      cursor: pointer;
      white-space: nowrap;
    }

    .chat-form button:disabled {
      opacity: .4;
      cursor: default;
    }

    .status {
      padding: 4px 12px 0;
      font-size: 11px;
      color: #9ca3af;
    }
  </style>
</head>

<body>
  <div class="chat-wrap">
    <header class="chat-header">
      <div class="avatar">
        <!-- ICI l'image de ton avatar -->
        <img src="assets/images/avatar-brahms.png" alt="Avatar du guide">
      </div>
      <div class="info">
        <h1>Chat privé</h1>
        <span>Pose ta question, je te répondrai dès que possible.</span>
      </div>
    </header>

    <div class="status" id="status">Connexion en cours…</div>

    <main class="chat-messages" id="messages" aria-live="polite"></main>

    <form class="chat-form" id="chatForm">
      <input
        id="chatInput"
        type="text"
        autocomplete="off"
        placeholder="Écris ton message…"
        required
      />
      <button type="submit">Envoyer</button>
    </form>
  </div>

  <!-- Firebase + chat -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getAuth,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Même config que sur index.html
    const firebaseConfig = {
      apiKey: "AIzaSyAd_3Qa9allKo9o4qZQQf3XVdRs3JMEGUQ",
      authDomain: "enneagramme-chat.firebaseapp.com",
      projectId: "enneagramme-chat",
      storageBucket: "enneagramme-chat.firebasestorage.app",
      messagingSenderId: "703457736548",
      appId: "1:703457736548:web:f91f0a1f36fd1a441e6c71",
      measurementId: "G-6WB7Y3E5CK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const statusEl   = document.getElementById("status");
    const messagesEl = document.getElementById("messages");
    const form       = document.getElementById("chatForm");
    const input      = document.getElementById("chatInput");

    // Petit identifiant stocké dans le navigateur pour différencier tes visiteurs
    let localId = localStorage.getItem("chatPriveId");
    if (!localId) {
      localId = "user_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("chatPriveId", localId);
    }

    // Connexion anonyme
    signInAnonymously(auth)
      .then(() => {
        console.log("✔️ Utilisateur anonyme connecté (chat privé)");
        statusEl.textContent = "Connecté.";
        initChat();
      })
      .catch(err => {
        console.error("Erreur auth (chat privé) :", err);
        statusEl.textContent = "Impossible de se connecter au chat.";
        form.querySelector("button").disabled = true;
      });

    function initChat() {
      const messagesRef = collection(db, "chatPrive");
      const q = query(messagesRef, orderBy("createdAt", "asc"));

      onSnapshot(q, snap => {
        messagesEl.innerHTML = "";
        snap.forEach(doc => {
          const data = doc.data();
          const msg = document.createElement("div");
          msg.className = "msg " + (data.authorId === localId ? "me" : "other");
          msg.innerHTML = `
            <div>${(data.text || "").toString()}</div>
            <div class="msg-meta">${data.authorId === localId ? "Moi" : "Guide"} · ${
              data.createdAt?.toDate
                ? data.createdAt.toDate().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})
                : ""
            }</div>
          `;
          messagesEl.appendChild(msg);
        });
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        form.querySelector("button").disabled = true;

        try {
          await addDoc(messagesRef, {
            text,
            authorId: localId,
            createdAt: serverTimestamp()
          });
          input.value = "";
        } catch (err) {
          console.error("Erreur d'envoi :", err);
          alert("Message non envoyé, réessaie dans un instant.");
        } finally {
          form.querySelector("button").disabled = false;
          input.focus();
        }
      });
    }
  </script>
</body>
</html>
