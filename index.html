<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ennéagramme</title>

  <link rel="stylesheet" href="assets/css/app.css?v=201" />

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1XYJK71TC4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1XYJK71TC4');
  </script>

  <style>
    /* ===== Boutons "chat" mis en valeur (léger) ===== */
    .btn-chat{
      border: 1px solid rgba(99,102,241,.75) !important;
      box-shadow: 0 0 0 3px rgba(99,102,241,.18) !important;
      position: relative;
    }
    .btn-chat:hover{
      box-shadow: 0 0 0 4px rgba(99,102,241,.26), 0 10px 22px rgba(0,0,0,.25) !important;
      transform: translateY(-1px);
    }
    .btn-chat:active{
      transform: translateY(0);
      box-shadow: 0 0 0 3px rgba(99,102,241,.18) !important;
    }
    .btn-chat:focus-visible{
      outline: none;
      box-shadow: 0 0 0 4px rgba(99,102,241,.35), 0 0 0 2px rgba(255,255,255,.12) inset !important;
    }

    /* ===== Modal chat privé (léger, sans toucher au thème global) ===== */
    .chatOverlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:3000;
    }
    .chatOverlay.open{display:flex}

    .chatModal{
      width:min(920px, 100%);
      height:min(88vh, 900px);
      background:rgba(10,14,28,.92);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      box-shadow: 0 24px 80px rgba(0,0,0,.65);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .chatModalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(8,12,24,.75);
    }

    .chatModalHeader .title{
      font-weight:700;
      letter-spacing:.2px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      color:rgba(255,255,255,.9);
    }

    .chatModalHeader .title .hint{
      opacity:.7;
      font-weight:500;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .chatModalHeader .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .chatFrame{
      border:0;
      width:100%;
      height:100%;
      flex:1;
      background:#000;
    }

    @media (max-width: 900px){
      .chatModal{height:92vh}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="top">
      <div>
        <h1>Ennéagramme</h1>
        <p id="subtitle">Clique sur un type pour voir un résumé, puis ouvrir la fiche complète.</p>
      </div>
      <div class="actions">
        <button id="btnReset" type="button">Réinitialiser</button>
        <button id="chatOpenBtn" type="button" class="btn btn-chat">Poser une question</button>
      </div>
    </header>

    <main class="grid">
      <section class="stage" id="stage">
        <div class="svgWrap">
          <svg id="enneaSvg" viewBox="0 0 700 700" aria-label="Diagramme de l'ennéagramme">
            <defs>
              <marker id="arrowHeadGreen" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto" markerUnits="strokeWidth">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(134,239,172,.95)"></path>
              </marker>
              <marker id="arrowHeadPink" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto" markerUnits="strokeWidth">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(253,164,175,.95)"></path>
              </marker>

              <filter id="softGlow" x="-30%" y="-30%" width="160%" height="160%">
                <feGaussianBlur stdDeviation="2.2" result="blur" />
                <feMerge>
                  <feMergeNode in="blur" />
                  <feMergeNode in="SourceGraphic" />
                </feMerge>
              </filter>
            </defs>

            <circle class="ring" cx="350" cy="350" r="270"></circle>
            <circle class="innerRing" cx="350" cy="350" r="210"></circle>

            <text x="350" y="352" text-anchor="middle" dominant-baseline="middle"
                  style="font-family: ui-serif, Georgia, 'Times New Roman', serif; font-weight: 800; letter-spacing: 1.5px; font-size: 26px; fill: rgba(255,255,255,.22); text-transform: uppercase;">
              Ennéagramme
            </text>

            <g id="staticBg" class="staticBg">
              <path class="hex" d="" id="hexPath"></path>
              <path class="tri" d="" id="triPath"></path>

              <g class="centers">
                <path class="centerLine" d="M350 350 L350 120"></path>
                <path class="centerLine" d="M350 350 L585 455"></path>
                <path class="centerLine" d="M350 350 L115 455"></path>

                <text class="centerLabel instinctif" x="350" y="255" text-anchor="middle">Instinctif</text>
                <text class="centerLabel emotionnel" x="468" y="415" text-anchor="middle">Émotionnel</text>
                <text class="centerLabel mental" x="232" y="415" text-anchor="middle">Mental</text>
              </g>
            </g>

            <g id="arrowsLayer"></g>
            <g id="nodesLayer"></g>
          </svg>
        </div>
      </section>

      <aside class="side" id="sidePanel" aria-live="polite">
        <div class="badgeRow">
          <div class="badge"><strong>Type</strong> <span id="badgeNum">—</span></div>
        </div>

        <div class="card">
          <div class="miniGrid">
            <div class="mini"><h3>Centre d'intelligence</h3><p id="center">—</p></div>
            <div class="mini"><h3>Peur de base</h3><p id="fear">—</p></div>
            <div class="mini"><h3>Désir de base</h3><p id="desire">—</p></div>
            <div class="mini"><h3>Compulsion (évitement)</h3><p id="compulsion">—</p></div>
          </div>

          <div class="moveLines">
            <div id="moveHealth" class="moveLine">
              <div class="moveHead">
                <span class="dot good"></span>
                <strong>Intégration</strong>
                <span class="muted">(santé)</span>
                <span class="muted"> > </span>
                <strong id="toIntegr">—</strong>
                <span class="muted">:</span>
              </div>
              <div class="moveBody" id="moveHealthText">—</div>
            </div>

            <div id="moveStress" class="moveLine">
              <div class="moveHead">
                <span class="dot warn"></span>
                <strong>Désintégration</strong>
                <span class="muted">(stress)</span>
                <span class="muted"> > </span>
                <strong id="toDisint">—</strong>
                <span class="muted">:</span>
              </div>
              <div class="moveBody" id="moveStressText">—</div>
            </div>
          </div>

          <div class="ctaRow">
            <a id="openFull" class="btn" href="profils/type1.html" aria-disabled="true">Voir la fiche complète</a>
            <a id="openProfil" class="btn" href="test-enneagramme-sans-indice.html">Passer le test</a>
            <a class="btn" href="explore.html">Explorer l'Ennéagramme</a>
            <button id="btnChooseProfiles" class="btn" type="button">Explorer les profils</button>
            <button id="chatOpenBtn2" class="btn btn-chat" type="button">Poser une question</button>
          </div>
        </div>
      </aside>
    </main>

    <footer class="siteFooter">
      <div class="footerInner">
        <span class="copy">Tous droits réservés</span>
        <a class="contact" href="https://docs.google.com/forms/d/e/1FAIpQLScLBwWZA-VZf4OaIEl11fnKasayyVrll7DZL5A3uZZBCwLdkQ/viewform?usp=header" target="_blank" rel="noopener">
          ✉️ Contact
        </a>
      </div>
    </footer>
  </div>

  <!-- Fenêtre chat privé (modal) -->
  <div class="chatOverlay" id="chatOverlay" aria-hidden="true">
    <div class="chatModal" role="dialog" aria-modal="true" aria-label="Chat privé">
      <div class="chatModalHeader">
        <div class="title">
          <span>Chat privé</span>
          <span class="hint">Fermer pour revenir à l’accueil</span>
        </div>
        <div class="actions">
          <button class="btn" id="chatCloseBtn" type="button">Fermer</button>
        </div>
      </div>
      <iframe
        class="chatFrame"
        id="chatFrame"
        src="https://ressources-pratiques-pro.github.io/enn-agramme-/chat-prive.html"
        title="Chat privé"></iframe>
    </div>
  </div>

  <script src="assets/js/app.js?v=200"></script>

  <script>
  (function(){
    const btn = document.getElementById('btnChooseProfiles');
    const stage = document.getElementById('stage');
    const svg = document.getElementById('enneaSvg');
    const subtitle = document.getElementById('subtitle');

    let chooseMode = false;
    let subtitleBackup = subtitle ? subtitle.textContent : '';

    function getNodes(){
      return Array.from(document.querySelectorAll('#nodesLayer .node'));
    }

    function setHint(on){
      const nodes = getNodes();
      nodes.forEach(n => n.classList.toggle('hint', on));
    }

    function enterChooseMode(){
      chooseMode = true;
      setHint(true);
      if (subtitle){
        subtitleBackup = subtitle.textContent || subtitleBackup;
        subtitle.textContent = "Choisis un type sur le diagramme pour ouvrir directement la fiche.";
      }
      stage.scrollIntoView({ behavior:'smooth', block:'start' });
      setTimeout(()=>setHint(true), 250);
    }

    function exitChooseMode(){
      chooseMode = false;
      setHint(false);
      if (subtitle) subtitle.textContent = subtitleBackup;
    }

    btn && btn.addEventListener('click', function(){
      if (!chooseMode) enterChooseMode();
      else exitChooseMode();
    });

    svg && svg.addEventListener('click', function(e){
      if (!chooseMode) return;

      const node = e.target && e.target.closest ? e.target.closest('.node') : null;
      if (!node) return;

      e.preventDefault();
      e.stopPropagation();
      if (e.stopImmediatePropagation) e.stopImmediatePropagation();

      let num = node.getAttribute('data-num') || node.getAttribute('data-type') || '';
      if (!num){
        const t = node.querySelector('text');
        num = t ? (t.textContent || '').trim() : '';
      }
      if (!/^[1-9]$/.test(num)) return;

      window.location.href = 'profils/type' + num + '.html';
    }, true);

    function waitNodes(){
      const nodes = getNodes();
      if (nodes.length){
        nodes.forEach(n=>{
          if (!n.hasAttribute('tabindex')) n.setAttribute('tabindex','0');
        });
        return;
      }
      requestAnimationFrame(waitNodes);
    }
    waitNodes();
  })();
  </script>

  <script>
    (function(){
      const chatOverlay = document.getElementById("chatOverlay");
      const chatCloseBtn = document.getElementById("chatCloseBtn");
      const open1 = document.getElementById("chatOpenBtn");
      const open2 = document.getElementById("chatOpenBtn2");

      function openChat(){
        if(!chatOverlay) return;
        chatOverlay.classList.add("open");
        chatOverlay.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
        chatCloseBtn && chatCloseBtn.focus();
      }

      function closeChat(){
        if(!chatOverlay) return;
        chatOverlay.classList.remove("open");
        chatOverlay.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
        (open2 || open1) && (open2 || open1).focus();
      }

      open1 && open1.addEventListener("click", openChat);
      open2 && open2.addEventListener("click", openChat);
      chatCloseBtn && chatCloseBtn.addEventListener("click", closeChat);

      chatOverlay && chatOverlay.addEventListener("click", (e)=>{
        if(e.target === chatOverlay) closeChat();
      });

      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape" && chatOverlay && chatOverlay.classList.contains("open")){
          closeChat();
        }
      });
    })();
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAd_3Qa9allKo9o4qZQQf3XVdRs3JMEGUQ",
      authDomain: "enneagramme-chat.firebaseapp.com",
      projectId: "enneagramme-chat",
      storageBucket: "enneagramme-chat.firebasestorage.app",
      messagingSenderId: "703457736548",
      appId: "1:703457736548:web:f91f0a1f36fd1a441e6c71",
      measurementId: "G-6WB7Y3E5CK"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    signInAnonymously(auth)
      .then(() => {
        console.log("✔️ Firebase OK : utilisateur anonyme connecté (index)");
      })
      .catch(err => {
        console.error("Erreur auth Firebase (index) :", err);
      });
  </script>

  <script>
  (function () {
    const badgeNum = document.getElementById("badgeNum");
    const openFull = document.getElementById("openFull");
    if (!badgeNum || !openFull) return;

    function currentType() {
      const t = (badgeNum.textContent || "").trim();
      return /^[1-9]$/.test(t) ? t : null;
    }

    function syncLink() {
      const t = currentType();
      if (!t) {
        openFull.setAttribute("aria-disabled", "true");
        openFull.dataset.forcedHref = "";
        return;
      }
      const href = `profils/type${t}.html`;
      openFull.href = href;
      openFull.dataset.forcedHref = href;
      openFull.setAttribute("aria-disabled", "false");
    }

    syncLink();

    const obs = new MutationObserver(syncLink);
    obs.observe(badgeNum, { childList: true, characterData: true, subtree: true });

    openFull.addEventListener("click", (e) => {
      syncLink();
      const href = openFull.dataset.forcedHref;
      if (!href) e.preventDefault();
    }, true);
  })();
  </script>
</body>
</html>
